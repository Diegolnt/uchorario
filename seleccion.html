<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCHorario - Selección de Amigos</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href='https://fonts.googleapis.com/css?family=Varela+Round' rel='stylesheet'>
</head>
<body>
    <img src="https://uniconexed.org/wp-content/uploads/2022/02/Pontificia-Universidad-Catolica-de-Chile-Logo.png" 
         alt="Logo UC" 
         class="logo-uc">
    
    <div class="container-center">
        <div class="selection-box">
            <h1>Selección de Amigos</h1>
            <p>Selecciona las personas cuyos horarios quieres consultar:</p>
            
            <div id="loading" class="loading">
                <p>Cargando personas...</p>
            </div>
            
            <div id="checkboxContainer" class="checkbox-container" style="display: none;">
                <!-- Los checkboxes se generan dinámicamente -->
            </div>
            
            <div id="errorMessage" class="error-message" style="display: none;">
                <p>Error al cargar las personas. Por favor, intenta de nuevo.</p>
            </div>
            
            <div class="button-group">
                <button onclick="goBack()" class="btn-secondary">Volver</button>
                <button onclick="saveSelection()" class="btn-primary" id="saveButton" disabled>Continuar</button>
            </div>
        </div>
    </div>

    <div class="stars">
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/storage.js"></script>
    <script>
        let allPersons = [];

        // Cargar personas al inicio
        window.addEventListener('DOMContentLoaded', async () => {
            await loadPersons();
        });

        async function loadPersons() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('checkboxContainer');
            const errorMessage = document.getElementById('errorMessage');
            
            try {
                allPersons = await API.getPersons();
                
                if (allPersons.length === 0) {
                    throw new Error('No se encontraron personas');
                }
                
                // Ocultar loading y mostrar checkboxes
                loading.style.display = 'none';
                container.style.display = 'block';
                
                // Obtener amigos guardados previamente
                const savedFriends = Storage.getFriends();
                
                // Crear checkboxes
                allPersons.forEach(person => {
                    const checkboxWrapper = document.createElement('div');
                    checkboxWrapper.className = 'checkbox-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `person_${person}`;
                    checkbox.value = person;
                    checkbox.checked = savedFriends.includes(person);
                    checkbox.addEventListener('change', updateSaveButton);
                    
                    const label = document.createElement('label');
                    label.htmlFor = `person_${person}`;
                    label.textContent = person;
                    
                    checkboxWrapper.appendChild(checkbox);
                    checkboxWrapper.appendChild(label);
                    container.appendChild(checkboxWrapper);
                });
                
                updateSaveButton();
                
            } catch (error) {
                console.error('Error:', error);
                loading.style.display = 'none';
                errorMessage.style.display = 'block';
            }
        }

        function updateSaveButton() {
            const checkboxes = document.querySelectorAll('#checkboxContainer input[type="checkbox"]');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const saveButton = document.getElementById('saveButton');
            
            saveButton.disabled = checkedCount === 0;
        }

        function saveSelection() {
            const checkboxes = document.querySelectorAll('#checkboxContainer input[type="checkbox"]:checked');
            const selectedFriends = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedFriends.length > 0) {
                Storage.saveFriends(selectedFriends);
                window.location.href = 'dashboard.html';
            } else {
                alert('Por favor, selecciona al menos una persona');
            }
        }

        function goBack() {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>